<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>MINTverse - Accelerating Complex Systems at Scale</title>
    <meta name="description" content="200,000× faster. From 96 hours to 90 seconds.">

    <style>
      :root{
        --black:#000; 
        --white:#fff;
        --green:#00d4aa; 
        --accent:#0071e3;
        --accent-glow:#0051a2;
        --text-muted:#86868b;
        --text-primary:#f5f5f7;
        --gray-300:#d2d2d7;
        --brand-text-gradient: linear-gradient(90deg, #fff 0%, var(--green) 100%);
        --cards-offset: clamp(160px, 24vh, 380px);
        --copy-delay: 1s;
        --copy-reveal-duration: .5s;
      }
      
      *{ margin:0; padding:0; box-sizing:border-box; }
      html{ scroll-behavior:smooth; }
      body{
        font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','Segoe UI',Roboto,Helvetica,Arial,sans-serif;
        background:#000; color:#fff; line-height:1.6; overflow-x:hidden;
        -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      }

      /* Loading bar */
      .loading-bar{
        position:fixed; top:0; left:0; right:0; height:2px;
        background:linear-gradient(90deg, var(--green) 0%, var(--accent) 100%);
        transform-origin:left;
        animation:loadingBar 1.5s cubic-bezier(.4,0,.2,1) forwards;
        z-index:10001;
      }
      @keyframes loadingBar{
        0%{transform:scaleX(0);opacity:1}
        90%{transform:scaleX(1);opacity:1}
        100%{transform:scaleX(1);opacity:0}
      }

      /* Intro overlay */
      html.intro-lock, body.intro-lock{ height:100%; overflow:hidden; }
      body.intro-lock::-webkit-scrollbar{ display:none; }

      .cinematic-intro{
        position:fixed; inset:0; z-index:10000; background:#000;
        display:flex; align-items:center; justify-content:center;
        transition:opacity 1s cubic-bezier(.4,0,.2,1);
      }
      .cinematic-intro.hide{ opacity:0; pointer-events:none; }
      .cinematic-intro.complete{ display:none; }

      .intro-grid{
        position:absolute; top:-50%; left:-50%; width:200%; height:200%;
        background:url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse"><path d="M 100 0 L 0 0 0 100" fill="none" stroke="rgba(255,255,255,0.02)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
        animation:driftSlow 30s linear infinite; opacity:0; animation-delay:.5s; animation-fill-mode:forwards;
      }
      @keyframes driftSlow{
        0%{transform:translate(0,0);opacity:0}
        10%{opacity:.5}
        100%{transform:translate(100px,100px);opacity:.5}
      }

      .intro-halo{
        position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
        width:120%; height:120%;
        background:radial-gradient(600px 400px at 50% 50%,
          rgba(0,212,170,.35),
          rgba(0,113,227,.22) 30%,
          rgba(0,0,0,0) 70%);
        filter:blur(60px); opacity:0;
        animation:haloReveal 3s cubic-bezier(.4,0,.2,1) forwards, haloBreathe 8s ease-in-out infinite alternate;
        animation-delay:.5s, 3s;
      }
      @keyframes haloReveal{ to{opacity:.8} }
      @keyframes haloBreathe{
        0%{ transform:translate(-50%,-50%) scale(1) }
        100%{ transform:translate(-50%,-48%) scale(1.05) }
      }

      .intro-content{ position:relative; z-index:2; text-align:center; max-width:900px; padding:0 40px; }
      .intro-logo{
        font-size:clamp(60px,10vw,120px); font-weight:700; letter-spacing:-.04em;
        background:var(--brand-text-gradient);
        -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
        opacity:0; transform:scale(.95);
        animation:logoReveal 1.5s cubic-bezier(.4,0,.2,1) forwards; animation-delay:1s;
        transition:transform .6s ease, opacity .6s ease;
      }
      @keyframes logoReveal{ to{opacity:1; transform:scale(1)} }

      .intro-content.cards-phase .intro-logo{ transform:translateY(-10px) scale(.9); opacity:.75; }
      .intro-content.cards-phase .intro-tagline{ opacity:.85; }
      .intro-content.cards-phase .intro-context{ opacity:.9; }

      .intro-tagline{
        font-size:clamp(20px,3vw,32px);
        color:var(--text-muted);
        margin:16px 0 6px; position:relative;
      }
      .intro-tagline span{
        display:inline-block; opacity:0; transform:translateY(20px);
        animation:fadeUp 1s cubic-bezier(.4,0,.2,1) forwards; animation-delay:2.5s;
      }

      .intro-context{
        font-size:18px; color:#d2d2d7; margin-top:10px; opacity:0; position:relative; display:inline-block;
        animation:fadeUp 1s cubic-bezier(.4,0,.2,1) forwards; animation-delay:4s;
      }
      .intro-context::after{
        content:''; position:absolute; left:50%; transform:translateX(-50%);
        bottom:-10px; width:0; height:2px;
        background:linear-gradient(90deg, var(--green), var(--accent));
        box-shadow:0 0 20px rgba(0,212,170,.35);
        animation:lineGrow 2s cubic-bezier(.4,0,.2,1) forwards; animation-delay:4s;
      }

      @keyframes fadeUp{ from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:translateY(0)} }
      @keyframes lineGrow{ to{ width:60% } }

      /* Title cards */
      .title-cards{
        position: relative;
        margin-top: var(--cards-offset);
        width: 100%;
        max-width: min(92vw, 720px);
        padding-inline: 16px;
        opacity: 0;
        animation: cardsReveal .5s forwards;
        animation-delay: 6s;
      }
      @keyframes cardsReveal{ to{opacity:1} }
      .title-card{ position:absolute; inset:auto 0 0 0; text-align:center; opacity:0; transform:scale(.98); transition:all 1s cubic-bezier(.4,0,.2,1); }
      .title-card.active{ opacity:1; transform:scale(1); }
      .title-card h2{
        font-size:clamp(36px,6.2vw,64px); font-weight:700;
        background:linear-gradient(90deg, var(--green) 0%, #00ffcc 100%);
        -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
        margin-bottom:10px; line-height:1.05; text-wrap:balance;
      }
      .title-card p{ font-size:clamp(16px,2.6vw,20px); color:var(--text-muted); }

      .skip-intro{
        position:absolute; bottom:40px; right:40px; color:#86868b; font-size:14px; text-decoration:none;
        opacity:0; animation:fadeIn 1s forwards; animation-delay:2s; transition:color .3s; cursor:pointer;
      }
      .skip-intro:hover{ color:#fff; }
      @keyframes fadeIn{ to{opacity:.6} }

      /* Hide scrollbar on root while preserving scroll */
      html.hide-scrollbar, body.hide-scrollbar {
      -ms-overflow-style: none;      /* IE/Edge legacy */
      scrollbar-width: none;         /* Firefox */
      }
      html.hide-scrollbar::-webkit-scrollbar,
      body.hide-scrollbar::-webkit-scrollbar {
      width: 0;
      height: 0;
      display: none;                 /* Chrome/Safari/Opera/Edge (Blink/WebKit) */
      }

      body { scrollbar-gutter: stable; }


      /* Scroll-scrub section */
      .scroll-scrub-section{ position:relative; height: calc(100vh * 4); z-index:100; display:none; }
      @media (max-width:768px){
      .scroll-scrub-section{
         height: calc(100dvh * 4);
      }
      }

      .scroll-scrub-content{
        position:sticky; top:0; height:100vh; display:flex; align-items:center; justify-content:center; overflow:hidden; background:#000;
      }

      .scrub-beat{
        position:absolute; width:100%; text-align:center; opacity:0; transform:scale(.9);
        transition:all .8s cubic-bezier(.4,0,.2,1);
      }
      .scrub-beat.active{ opacity:1; transform:scale(1); }
      .scrub-beat.fade-in{ animation:beatFadeIn 1s cubic-bezier(.4,0,.2,1) forwards; }
      @keyframes beatFadeIn{ from{opacity:0; transform:scale(.95)} to{opacity:1; transform:scale(1)} }

      .scrub-beat h2{
        font-size:clamp(48px,8vw,96px); font-weight:700;
        background:linear-gradient(180deg,#fff 0%,#86868b 100%);
        -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
        margin-bottom:20px;
      }
      .scrub-beat p{
        font-size:clamp(18px,2.5vw,28px); color:var(--text-muted);
        position:relative; display:inline-block; padding-bottom:10px;
        opacity: 0;
        transform: translateY(8px);
        transition:
          opacity var(--copy-reveal-duration) cubic-bezier(.4,0,.2,1) var(--copy-delay),
          transform var(--copy-reveal-duration) cubic-bezier(.4,0,.2,1) var(--copy-delay);
      }
      .scrub-beat.active p, .scrub-beat.seen p{
        opacity: 1;
        transform: translateY(0);
      }
      /* underline for copy paragraphs on beats 1–3 only */
      .scrub-beat:not(#beat4) p::after{
        content:'';
        position:absolute;
        left:0;
        bottom:-8px;
        width:100%;
        height:2px;
        background:linear-gradient(90deg, var(--green), var(--accent));
        box-shadow:0 0 20px rgba(0,212,170,.35);
        transform:scaleX(0);
        transform-origin:center; 
        transition: transform .6s cubic-bezier(.4,0,.2,1) var(--copy-delay);
      }
      .scrub-beat:not(#beat4).active p::after,
      .scrub-beat:not(#beat4).seen p::after{
        transform:scaleX(1);
      }


      /* Beat 4 - Apple-style reveal + live metrics */
      #beat4{
        display:flex;
        flex-direction:column;
        align-items:center;
        gap:32px;
      }

      #beat4 h2{
        font-size:clamp(60px,10vw,120px);
        background:var(--brand-text-gradient);
        -webkit-background-clip:text; 
        -webkit-text-fill-color:transparent; 
        background-clip:text;
        letter-spacing:-.02em;
      }

      /* Subtle, Apple-like staged reveals */
      .reveal-up{ opacity:0; transform:translateY(8px); transition:opacity .7s cubic-bezier(.4,0,.2,1), transform .7s cubic-bezier(.4,0,.2,1); }
      .reveal-fade{ opacity:0; transition:opacity .7s cubic-bezier(.4,0,.2,1); }
      .show{ opacity:1 !important; transform:translateY(0) !important; }

      #beat4 .subtitle{
        position:relative;
        display:inline-block;
        padding-bottom:10px;
        font-size:clamp(21px,3vw,32px);
        color:var(--gray-300);
        margin-top:-16px;
      }
      /* Underline for subtitle (center-out after subtitle shows) */
      #beat4 .subtitle::after{
        content:'';
        position:absolute;
        left:0; right:0;
        bottom:-8px;
        height:2px;
        background:linear-gradient(90deg, var(--green), var(--accent));
        box-shadow:0 0 20px rgba(0,212,170,.35);
        transform:scaleX(0);
        transform-origin:center;
        transition:transform .6s cubic-bezier(.4,0,.2,1);
      }
      #beat4 .subtitle.underline::after{ transform:scaleX(1); }

      /*
        IMPORTANT: Use CSS Grid with fixed tracks so left/right metrics
        occupy their cells from the start. This prevents any horizontal push
        when they fade in.
      */
      .metrics{
        display:grid;
        grid-template-columns: repeat(3, minmax(220px, 260px));
        justify-content:center;
        align-items:start;
        column-gap:64px;
        row-gap:40px;
        margin-top:48px;
        width:100%;
      }

      @media (max-width:768px){
        .metrics{ grid-template-columns: 1fr; }
      }

      .metric{ text-align:center; opacity:0; transform:translateY(8px); transition:opacity .7s cubic-bezier(.4,0,.2,1), transform .7s cubic-bezier(.4,0,.2,1); }
      .metric.show{ opacity:1; transform:none; }

      .metric-number{
        font-size:clamp(40px,8vw,64px);
        font-weight:700;
        letter-spacing:-.02em;
        line-height:1;
        background:linear-gradient(180deg, var(--text-primary) 0%, var(--text-muted) 100%);
        -webkit-background-clip:text;
        -webkit-text-fill-color:transparent;
        background-clip:text;
        position:relative;
        font-variant-numeric: tabular-nums;
        font-feature-settings: 'tnum' 1;
        min-width: var(--minch, 0);
        display:inline-block;
        text-align:center;
      }
      /* One-time specular sweep once the count completes */
      .metric-number.sheen::after{
        content:""; position:absolute; top:0; bottom:0; width:18%; min-width:90px; pointer-events:none;
        background:linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.35) 50%, rgba(255,255,255,0) 100%);
        transform:skewX(-20deg) translateX(-130%);
        filter:blur(1px);
        animation:specularSweep 1.1s cubic-bezier(.4,0,.2,1) forwards;
      }
      @keyframes specularSweep{ to{ transform:skewX(-20deg) translateX(130%); opacity:0 } }

      .metric-unit{ font-size:20px; font-weight:400; color:var(--green); margin-top:8px; }
      .metric-label{ font-size:15px; color:var(--text-muted); margin-top:12px; line-height:1.4; }

      /* Launch date – underline and text appear together after metrics end */
      .launch-date{
        position:relative;
        display:inline-block;
        margin-top:48px;
      }
      .launch-date .text{
        display:inline-block;
        font-size:clamp(28px,4vw,40px);
        font-weight:500;
        color:var(--text-primary);
        letter-spacing:.01em;
        opacity:0;
        transform:translateY(6px);
        transition:opacity .6s cubic-bezier(.4,0,.2,1), transform .6s cubic-bezier(.4,0,.2,1);
      }
      .launch-date::after{
        content:'';
        position:absolute;
        left:0; right:0;
        bottom:-10px;
        height:2px;
        background:linear-gradient(90deg, var(--green), var(--accent));
        box-shadow:0 0 20px rgba(0,212,170,.35);
        transform:scaleX(0);
        transform-origin:center;
        transition:transform .6s cubic-bezier(.4,0,.2,1);
      }
      .launch-date.underline::after{ transform:scaleX(1); }
      .launch-date.show-text .text{ opacity:1; transform:translateY(0); }

      .links{ display:flex; gap:32px; justify-content:center; margin-top:32px; }
      .link{ color:var(--accent); text-decoration:none; font-size:17px; transition:opacity .3s, transform .25s cubic-bezier(.4,0,.2,1); }
      .link:hover{ opacity:.85; transform:translateY(-1px); }

      .validation{ font-size:13px; color:var(--text-muted); margin-top:48px; opacity:0; transition:opacity .6s cubic-bezier(.4,0,.2,1); }
      .validation.show{ opacity:1; }

      /* Fade to black */
      .cinematic-intro.fade-to-black .intro-grid,
      .cinematic-intro.fade-to-black .intro-halo{ opacity:0 !important; transition:opacity .5s cubic-bezier(.4,0,.2,1) !important; }
      .cinematic-intro.fade-to-black .intro-content{ opacity:0 !important; transition:opacity .6s cubic-bezier(.4,0,.2,1) !important; }

      /* Lock at end */
      html.end-lock, body.end-lock{ height:100%; overflow:hidden; }
      .end-lock #scrollScrub{ height:100vh !important; }
      .end-lock .scroll-scrub-content{ position:fixed; inset:0; }

      /* Gradient brand text utility */
      .gradient-brand-text{
        background:var(--brand-text-gradient);
        -webkit-background-clip:text; 
        -webkit-text-fill-color:transparent; 
        background-clip:text;
      }
      /* Apple-style footer */
      .footer-section{
      position: relative;
      text-align: center;
      margin-top: 56px;
      padding-top: 24px;
      color: var(--gray-300);
      opacity: 0; /* `.reveal-fade` / `.show` will handle reveal */
      transition: opacity .7s cubic-bezier(.4,0,.2,1);
      }
      .footer-section::before{
      content: "";
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: min(680px, 84%);
      height: 1px;
      background: linear-gradient(90deg,
         rgba(255,255,255,.06) 0%,
         rgba(255,255,255,.18) 50%,
         rgba(255,255,255,.06) 100%);
      }

      .footer-tagline{
      font-size: clamp(18px, 2.4vw, 22px);
      font-weight: 600;
      letter-spacing: .01em;
      color: var(--text-primary);
      }
      .footer-sub{
      margin-top: 6px;
      font-size: 15px;
      color: var(--text-muted);
      }
      .footer-meta{
      margin-top: 12px;
      font-size: 13px;
      color: var(--text-muted);
      letter-spacing: .01em;
      }

      /* Keep your existing reveal utility working */
      .footer-section.show{ opacity: 1; }

      /* Respect reduced motion */
      @media (prefers-reduced-motion: reduce){
        *{ animation: none !important; transition: none !important; }
      }
    </style>
  </head>
  <body>
    <div class="loading-bar"></div>

    <!-- Intro -->
    <div class="cinematic-intro" id="cinematicIntro">
      <div class="intro-grid"></div>
      <div class="intro-halo"></div>
      <div class="intro-content" id="introContent">
        <h1 class="intro-logo gradient-brand-text">MINTverse</h1>

        <div class="intro-tagline">
          <span>Hours become milliseconds.</span>
        </div>

        <p class="intro-context">The future of agent-based simulations.</p>
        <div class="title-cards">
          <div class="title-card" id="card1">
            <h2>200,000× faster</h2>
            <p>Than any system before it.</p>
          </div>
          <div class="title-card" id="card2">
            <h2>82,000 predictions</h2>
            <p>Every second. On your laptop.</p>
          </div>
          <div class="title-card" id="card3">
            <h2>64 billion data points</h2>
            <p>Instantly queryable.</p>
          </div>
        </div>
      </div>

      <a href="#" class="skip-intro" onclick="skipIntro(); return false;">Skip movie</a>
    </div>

    <!-- Beats -->
    <div class="scroll-scrub-section" id="scrollScrub">
      <div class="scroll-scrub-content">
        <div class="scrub-beat" id="beat1" style="--copy-delay: 1.0s">
          <h2>One interface.</h2>
          <p>Every query. Every model. Every scenario.</p>
        </div>
        <div class="scrub-beat" id="beat2" style="--copy-delay: 1.0s">
          <h2>Perfectly reproducible.</h2>
          <p>Today. Tomorrow. Always.</p>
        </div>
        <div class="scrub-beat" id="beat3" style="--copy-delay: 1.0s">
          <h2>Ready to ship.</h2>
          <p>Research to production. Instantly.</p>
        </div>
        <div class="scrub-beat" id="beat4">
          <!-- 1) Title appears immediately when beat4 becomes active -->
          <h2 class="gradient-brand-text">MINTverse</h2>
          
          <!-- 2) After 250ms, subtitle reveals -->
          <p class="subtitle reveal-up">96 hours → 90 seconds</p>
          
          <!-- 3) After another 250ms, metrics begin revealing; grid prevents layout shift -->
          <div class="metrics">
            <!-- SECONDARY (left) occupies its grid cell from the start -->
            <div class="metric secondary">
              <div class="metric-number" data-target="0.998" data-decimals="3" data-duration="1700" style="--minch:6ch">0</div>
              <div class="metric-unit">R²</div>
              <div class="metric-label">Neural accuracy<br>250k+ held-out series</div>
            </div>

            <!-- PRIMARY (center) -->
            <div class="metric primary">
              <div class="metric-number" data-target="200000" data-decimals="0" data-suffix="×" data-duration="1600" style="--minch:7ch">0</div>
              <div class="metric-unit">faster</div>
              <div class="metric-label">Than malariasimulation<br>on HPC clusters</div>
            </div>
            
            <!-- SECONDARY (right) -->
            <div class="metric secondary">
              <div class="metric-number" data-target="82000" data-decimals="0" data-duration="1800" style="--minch:6ch">0</div>
              <div class="metric-unit">per second</div>
              <div class="metric-label">Predictions on<br>RTX 40-series GPU</div>
            </div>
          </div>
          
          <!-- Launch date: underline grows center-out and text fades in simultaneously -->
          <p class="launch-date">
            <span class="text">Public release Q4 2025</span>
          </p>
          
          <div class="links reveal-up">
            <a href="mailto:cosmo.santoni@imperial.ac.uk?subject=MINTverse%20Early%20Access" class="link">Get notified ↗</a>
            <a href="https://github.com/CosmoNaught" class="link">View research ↗</a>
          </div>
          
          <div class="validation footer-section reveal-fade">
            <div class="footer-tagline">Designed for researchers. Engineered for impact.</div>
            <div class="footer-sub">From the MRC Centre for Global Infectious Disease Analysis</div>
            <div class="footer-meta">Imperial College London • Open Source • 2025</div>
          </div>          
        </div>
      </div>
    </div>

    <script>
      
      /* Scroll lock */
      const ScrollLock = (() => {
        let locked = false;
        function prevent(e){ e.preventDefault(); }
        function keyguard(e){
          const keys = [32,33,34,35,36,37,38,39,40];
          if (keys.includes(e.keyCode)) e.preventDefault();
        }
        return {
          enable(){
            if (locked) return;
            locked = true;
            document.documentElement.classList.add('intro-lock');
            document.body.classList.add('intro-lock');
            window.addEventListener('wheel', prevent, { passive:false });
            window.addEventListener('touchmove', prevent, { passive:false });
            window.addEventListener('keydown', keyguard, { passive:false });
          },
          disable(){
            if (!locked) return;
            locked = false;
            document.documentElement.classList.remove('intro-lock');
            document.body.classList.remove('intro-lock');
            window.removeEventListener('wheel', prevent);
            window.removeEventListener('touchmove', prevent);
            window.removeEventListener('keydown', keyguard);
          }
        };
      })();

      let introComplete = false;
      document.documentElement.classList.add('hide-scrollbar');
      document.body.classList.add('hide-scrollbar');

      function cinematicSequence(){
        const cards = [
          document.getElementById('card1'),
          document.getElementById('card2'),
          document.getElementById('card3')
        ];
        
        setTimeout(() => {
          document.getElementById('introContent')?.classList.add('cards-phase');
        }, 5600);

        setTimeout(() => { if(!introComplete) cards[0].classList.add('active'); }, 6000);
        setTimeout(() => {
          if(!introComplete){ cards[0].classList.remove('active'); cards[1].classList.add('active'); }
        }, 8500);
        setTimeout(() => {
          if(!introComplete){ cards[1].classList.remove('active'); cards[2].classList.add('active'); }
        }, 11000);
        setTimeout(() => {
          if(!introComplete){ cards[2].classList.remove('active'); endIntro(); }
        }, 13500);
      }

      function skipIntro(){ introComplete = true; endIntro(); }

      function endIntro(){
        const intro = document.getElementById('cinematicIntro');
        const scrollScrub = document.getElementById('scrollScrub');
        const halo = document.querySelector('.intro-halo');

        if (halo) halo.style.display = 'none';
        intro.classList.add('fade-to-black');

        setTimeout(() => {
          intro.classList.add('hide');
          setTimeout(() => {
            intro.classList.add('complete');
            ScrollLock.disable();

            scrollScrub.style.display = 'block';
            scrollScrub.style.opacity = '0';
            setTimeout(() => {
              scrollScrub.style.transition = 'opacity .8s cubic-bezier(.4,0,.2,1)';
              scrollScrub.style.opacity = '1';
              setTimeout(() => {
                const beat1 = document.getElementById('beat1');
                if (beat1){
                  beat1.classList.add('active','fade-in');
                  beat1.addEventListener('animationend', () => beat1.classList.remove('fade-in'), { once:true });
                }
                initScrollScrub();
              }, 200);
            }, 300);
          }, 20);
        }, 600);
      }

      function initScrollScrub(){
      const scrubSection = document.getElementById('scrollScrub');
      const beats = ['beat1','beat2','beat3','comparison','beat4'].map(id => document.getElementById(id));
      const steps = beats.length - 1;
      const vh = () => window.innerHeight;

      function setBeat(i){
         beats.forEach(b => b.classList.remove('active'));
         beats[i].classList.add('active','seen');
         if (beats[i].id === 'beat4') startBeat4();
         if (i === steps) lockAtEnd(); // triggers the hard lock
      }

      let top = 0, height = 0, travel = 0, offsets = [];
      function compute(){
         const rect = scrubSection.getBoundingClientRect();
         top = window.pageYOffset + rect.top;
         height = scrubSection.offsetHeight;
         travel = Math.max(1, height - vh());
         offsets = Array.from({length: beats.length}, (_, i) => top + (travel * (i/steps)));
         // expose for lockAtEnd()
         window.__scrubOffsets = offsets;
         window.__scrubSteps = steps;
         window.__scrubRange = { top, travel };
      }
      compute();
      window.addEventListener('resize', compute);

      let last = 0;
      let endLocked = false;

      window.addEventListener('scroll', () => {
         if (endLocked) return; // do nothing once locked
         const y = window.pageYOffset || document.documentElement.scrollTop || 0;
         if (y < top || y > top + travel) return;
         const progress = (y - top) / travel;
         const i = Math.round(progress * steps);
         if (i !== last){ last = i; setBeat(i); }
      }, { passive:true });

      let animating = false;
      function scrollToStep(i){
         animating = true;
         window.scrollTo({ top: offsets[i], behavior: 'smooth' });
         setTimeout(() => { animating = false; }, 420);
      }

      scrubSection.addEventListener('wheel', (e) => {
         if (endLocked) { e.preventDefault(); return; }
         const y = window.pageYOffset || document.documentElement.scrollTop || 0;
         if (y < top - 1 || y > top + travel + 1) return;
         if (animating) { e.preventDefault(); return; }
         const dir = Math.sign(e.deltaY);
         if (!dir) return;
         e.preventDefault();
         const next = Math.max(0, Math.min(steps, last + dir));
         if (next !== last){ last = next; setBeat(next); scrollToStep(next); }
      }, { passive:false });

      window.addEventListener('keydown', (e) => {
         if (endLocked) return;
         const keysDown = ['ArrowDown','PageDown'];
         const keysUp   = ['ArrowUp','PageUp'];
         if (![...keysDown, ...keysUp].includes(e.key)) return;
         const y = window.pageYOffset || document.documentElement.scrollTop || 0;
         if (y < top - 1 || y > top + travel + 1) return;
         e.preventDefault();
         const dir = keysUp.includes(e.key) ? -1 : 1;
         const next = Math.max(0, Math.min(steps, last + dir));
         if (next !== last){ last = next; setBeat(next); scrollToStep(next); }
      });

      // kick off
      beats[0].classList.add('active','seen');

      // expose a hook to flip the guard when locked
      window.__setEndLocked = (v) => { endLocked = v; };
      }


      function lockAtEnd(){
      if (window.__endLocked) return;
      window.__endLocked = true;
      if (typeof window.__setEndLocked === 'function') window.__setEndLocked(true);

      document.documentElement.classList.add('end-lock');
      document.body.classList.add('end-lock');

      // Snap to the last beat's exact scroll position
      const lastTop = (window.__scrubOffsets?.[window.__scrubSteps]) ??
                        document.getElementById('scrollScrub').offsetTop;
      window.scrollTo({ top: lastTop, behavior: 'auto' });

      // Block any further navigation
      const prevent = e => e.preventDefault();
      window.addEventListener('wheel', prevent, { passive:false });
      window.addEventListener('touchmove', prevent, { passive:false });
      window.addEventListener('keydown', (e) => {
         const keys = ['ArrowUp','ArrowDown','PageUp','PageDown','Home','End',' '];
         if (keys.includes(e.key)) e.preventDefault();
      }, { passive:false });
      }


      /* === Beat 4: exact 0.25s staging + no layout shift === */
      const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      let beat4Started = false;

      function startBeat4(){
        if (beat4Started) return; // run once
        beat4Started = true;
        const beat4 = document.getElementById('beat4');
        const subtitle = beat4.querySelector('.subtitle');
        const metricsWrap = beat4.querySelector('.metrics');
        const primaryMetric = beat4.querySelector('.metric.primary');
        const secondaryMetrics = [...beat4.querySelectorAll('.metric.secondary')];
        const numbers = [...beat4.querySelectorAll('.metric-number')];
        const primaryNumber = primaryMetric.querySelector('.metric-number');
        const launch = beat4.querySelector('.launch-date');
        const links = beat4.querySelector('.links');
        const validation = beat4.querySelector('.validation');

        // Timings
        const T_PAUSE = 250; // exact 0.25s pauses requested
        const AFTER_H2 = T_PAUSE;            // subtitle appears after 0.25s
        const AFTER_SUBTITLE = T_PAUSE;      // metrics start after another 0.25s
         
        // 1) H2 is already visible when beat4 activates
        // 2) After 0.25s, reveal subtitle
        reveal(subtitle, AFTER_H2);
        setTimeout(() => subtitle.classList.add('underline'), AFTER_H2 + 100);

        // 3) After another 0.25s, begin metrics reveal
        setTimeout(() => {
          if (prefersReduced) {
            numbers.forEach(n => setNumberInstant(n));
            primaryMetric.classList.add('show');
            secondaryMetrics.forEach(m => m.classList.add('show'));
            triggerLaunchSequence(launch, links, validation);
            return;
          }

          // Show center immediately, then stagger sides to "start getting revealed"
          primaryMetric.classList.add('show');
          countTo(primaryNumber);

          // Reveal left then right with slight stagger, but grid keeps their space so no push
          secondaryMetrics.forEach((m, i) => {
            setTimeout(() => {
              m.classList.add('show');
              const num = m.querySelector('.metric-number');
              countTo(num);
            }, i * 180);
          });

          // Wait until all counters complete before launch underline + text
          let completed = 0;
          numbers.forEach(n => {
            n.addEventListener('metric:done', () => {
              completed += 1;
              if (completed === numbers.length) {
                triggerLaunchSequence(launch, links, validation);
              }
            }, { once: true });
          });
        }, AFTER_H2 + AFTER_SUBTITLE);
      }

      function triggerLaunchSequence(launch, links, validation){
        if (!launch) return;
        // Line grows center-out AND text fades in simultaneously
        launch.classList.add('underline', 'show-text');
        // Then links and footer
        reveal(links, 800);
        setTimeout(() => validation.classList.add('show'), 1050);
      }

      function reveal(el, delay = 0){ if(!el) return; setTimeout(()=> el.classList.add('show'), delay); }

      function setNumberInstant(el){
        const target = parseFloat(el.dataset.target || '0');
        const decimals = parseInt(el.dataset.decimals || '0', 10);
        const suffix = el.dataset.suffix || '';
        el.textContent = formatNumber(target, decimals) + suffix;
      }

      // Lightweight, time-based counter with easing and grouping
      function countTo(el){
        const start = 0;
        const target = parseFloat(el.dataset.target || '0');
        const decimals = parseInt(el.dataset.decimals || '0', 10);
        const suffix = el.dataset.suffix || '';
        const duration = Math.max(400, parseInt(el.dataset.duration || '1600', 10));
        const startTime = performance.now();

        function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

        function frame(now){
          const t = Math.min(1, (now - startTime) / duration);
          const eased = easeOutCubic(t);
          const value = start + (target - start) * eased;
          el.textContent = formatNumber(value, decimals) + suffix;
          if (t < 1) {
            requestAnimationFrame(frame);
          } else {
            // Snap to exact final and add one-time sheen
            el.textContent = formatNumber(target, decimals) + suffix;
            el.classList.add('sheen');
            setTimeout(()=> el.classList.remove('sheen'), 1300);
            // Announce completion
            el.dispatchEvent(new CustomEvent('metric:done', { bubbles: true }));
          }
        }
        requestAnimationFrame(frame);
      }

      function formatNumber(value, decimals){
        try{
          const fmt = new Intl.NumberFormat(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
          return fmt.format(Number(value));
        }catch(e){
          // Fallback
          return Number(value).toFixed(decimals);
        }
      }

      /* Boot */
      window.addEventListener('load', () => {
        ScrollLock.enable();
        cinematicSequence();

        setTimeout(() => {
          const loadingBar = document.querySelector('.loading-bar');
          if (loadingBar){ loadingBar.style.display = 'none'; }
        }, 1800);
      });
    </script>
  </body>
</html>
